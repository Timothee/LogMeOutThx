<html>
<head><title>LogMeOut Options</title>
<link rel="stylesheet" href="http://logmeoutthx.com/style.css" type="text/css"/>
<script type="text/javascript">

var ctrl, alt, shift, keyIdentifier;

// Retrieves KB shortcut setting
chrome.extension.sendRequest({command: "restoreOptions"}, restoreOptions);
function restoreOptions(response) {
  ctrl    = response.ctrl;
  alt     = response.alt;
  shift   = response.shift;
  keyIdentifier = response.keyIdentifier;
	updateShortcutField();
};

// Update textfield with saved or current shortcut
function updateShortcutField () {
	var shortcut = "";
	var mac = /Macintosh/i.test(navigator.userAgent);
	if (ctrl == "true")		shortcut += (mac?"\u2303":"Ctrl+");
	if (alt == "true")		shortcut += (mac?"\u2325":"Alt+");
	if (shift == "true")	shortcut += (mac?"\u21e7":"Shift+");
	shortcut += fromKeyIdentifier(keyIdentifier);
	// Shortcut needs at least one modifier key
	if (!(ctrl || alt || shift) || shortcut == "") {
	  shortcut = "Type shortcut";
	}
	document.getElementById('shortcut').value = shortcut;
}

// Resets KB (without saving) and starts listening to keystrokes
function startEditing() {
  ctrl = alt = shift = false;
  keyIdentifier = '';
  document.body.addEventListener('keydown', modifierKeys, true);
  document.body.addEventListener('keyup', modifierKeys, true);
  document.body.addEventListener('keypress', mainKey, true);
	document.getElementById('shortcut').style.color = "#666";
  updateShortcutField();
}

// Used for live updating before a "real" key is pressed
function modifierKeys (event) {
  if (event) {
    // Cancels if Esc is pressed
    if (event.keyCode == "27") {
      cancelEditing();
      return;
    }
    ctrl = event.ctrlKey + "";
    alt = event.altKey + "";
    shift = event.shiftKey + "";
  }
  updateShortcutField();
}

// Grabs the shortcut and saves it
function mainKey (event) {
	if (event) {
		if (ctrl == "true" || alt == "true" || shift == "true") {
			keyIdentifier = event.keyIdentifier;
			resetField();
			saveOptions();
			updateShortcutField();
		} else {
			keyIdentifier = '';
		}
	}
}

// Stops listeners
function resetField () {
  document.body.removeEventListener('keydown', modifierKeys, true);
  document.body.removeEventListener('keyup', modifierKeys, true);
  document.body.removeEventListener('keypress', mainKey, true);
	document.getElementById('shortcut').style.color = "#000";
}

// Called when Esc is pressed
function cancelEditing (argument) {
	resetField();
	chrome.extension.sendRequest({command: "restoreOptions"}, restoreOptions);
}

// Saves options to localStorage.
function saveOptions() {
	if (keyIdentifier == '') {
		return false;
	} else {
	  localStorage['ctrl']   	= ctrl;
	  localStorage['alt']     = alt;
	  localStorage['shift']   = shift;
		localStorage['keyIdentifier'] = keyIdentifier;
		return true;
	}
}

// Transforms keyIdentifier value into Unicode character
function fromKeyIdentifier (keyId) {
  if (res = /[0-9A-E]{2}\b/.exec(keyId)) {
   return unescape("%"+res[0]);
   // TODO try to use \uXXXX instead of unescape, so that any language should work
  // if (res = /U\+([0-9A-E]{4})\b/.exec(keyId)) {
    // return String('\\u'+res[1]);
	} else {
		return "";
	}
}

</script>
</head>

<body onload="updateShortcutField();">
<div id="header">
	<h1>LogMeOut</h1>
</div>
<div id="content">
	<div id="content_bottom"></div>
	<div id="options">
		<h2>Options</h2>
		<label for="shortcut">Keyboard shortcut:</label>
		<input type="text" id="shortcut" value='' onclick="startEditing();" readonly/>
		<br/>
	</div><!-- options -->
</div><!-- content -->
<div id="footer">
	&copy;2010 Timoth&eacute;e Boucher&mdash;<a href="http://timotheeboucher.com">timotheeboucher.com</a>
</div><!-- footer -->
<script type="text/javascript">
</script>
</body>
</html>